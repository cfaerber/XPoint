# $Id$
#  
#  Makefile.in -- OpenXP autoconf build system
#  
#  This software is part of the OpenXP project (www.openxp.de).
#  Copyright (c) 2000 by the OpenXP Team.
#  Created on 2002-01-13 by Claus F"arber <claus@faerber.muc.de>
#  
#  This is free software; you can redistribute it and/or modify it
#  under the terms of the Lesser GNU General Public License (LGPL) as
#  published by the Free Software Foundation; either version 2,
#  or (at your option) any later version.
#  
#  The software is distributed in the hope that it will be useful, but
#  WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See LGPL
#  for more details.
#  
#  You should have received a copy of the LGPL along with this
#  software; see the file lgpl.txt. If not, write to the
#  Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.

# --- variables -------------------------------------------------------
SHELL	= /bin/sh

# --- configuration ---------------------------------------------------
srcdir		= @srcdir@
prefix		= @prefix@
exec_prefix     = @exec_prefix@
bindir		= @bindir@
sbindir		= @sbindir@
libexecdir	= @libexecdir@
datadir		= @datadir@
sysconfdir	= @sysconfdir@
sharedstatedir	= @sharedstatedir@
localstatedir	= @localstatedir@
libdir		= @libdir@
includedir	= @includedir@
oldincludedir	= @oldincludedir@
infodir		= @infodir@
mandir		= @mandir@

# --- flags -----------------------------------------------------------

PPC	= @PPC@
PPC_FLAGS	= -Funetcall -FuObjCOM -Fulinux -dAUTOCONF
PPC_LOCAL_FLAGS = -Funetcall -FuObjCOM -Fulinux

# --- files -----------------------------------------------------------
EXEEXT 	= @EXEEXT@

OPENXP	= openxp@EXEEXT@
RC	= ./rc@EXEEXT@
IHS	= ./ihs@EXEEXT@

UNITS	=
INCLUDES=

RESSOURCE_FILES=$(patsubst openxp-%.rq,openxp-%.res,$(wildcard openxp-*.rq))
HELP_FILES=$(patsubst doc/openxp-%.ihq,openxp-%.hlp,$(wildcard doc/openxp-*.ihq))

# --- abstract targets ------------------------------------------------
all: bin res

bin: $(OPENXP) 

res: $(RESSOURCE_FILES) $(HELP_FILES)

# --- cleaning --------------------------------------------------------
mostlyclean:
	rm -f $(OPENXP) openxp-*.res *.dcu *.ppu *.o

clean: mostlyclean
	rm -f $(RC) $(IHS)

distclean: clean
	rm -f Makefile config.cache config.status config.h config.inc config.log

maintainer-clean: distclean
	rm -f configure

# --- install/uninstall -----------------------------------------------
install:
	install -D $(OPENXP) $(bindir)/$(OPENXP)
	install -d $(datadir)/openxp/
	install $(RESSOURCE_FILES) $(HELP_FILES) $(datadir)/openxp/

install-strip:
uninstall:

# --- main programme --------------------------------------------------
openxp$(EXEEXT): openxp.pas $(UNITS) config.h
	( sed -ne "s/^#\(.*\)/{\$$\1}/p" config.h &&	\
	  echo "const conf_prefix = '$(prefix)';" &&	\
	  echo "const conf_datadir = '$(datadir)';" ) 	> config.inc
	$(PPC) $(PPC_FLAGS) $<

# --- ressources ------------------------------------------------------
openxp-%.res: openxp-%.rq $(RC)
	$(RC) $<

rc$(EXEEXT): rc.pas $(UNITS) $(INCLUDES)
	$(PPC) $(PPC_LOCAL_FLAGS) $<

# --- in-programme help -----------------------------------------------

ihs$(EXEEXT): ihs.pas $(UNITS) $(INCLUDES)
	$(PPC) $(PPC_LOCAL_FLAGS) $<

openxp-%.hlp: doc/openxp-%.ihq $(IHS)
	$(IHS) $<
	cp doc/openxp-$*.hlp $@

# --- files list ------------------------------------------------------

MANIFEST.snap: $(OPENXP) $(RESSOURCE_FILES) $(HELP_FILES)
	(for a in $^ ; do echo $$a ; done) > FILELIST

# --- autoconf configuration PASCAL adaptions -------------------------
# config.inc: config.h Makefile
#	( 					\
# 	sed -ne "s/^#\(.*\)/{\$$\1}/p" $< &&	\
#	sed -ne "s/^CONF_\([A-Z_-]*\)[ 	]*=[ 	]*\(.*[^ 	]\)/const CONF_\1 = '\2';/p" Makefile \
#	) >$@

#		sed							\
#		  -e "s/^[^#].*/\/\/&/" 				\
#		  -e "s/^#\(.*\)/{\$$\1}/"				\
#		  -e "s/^\(\/\/[	 ]*\)\/[\/\*]/\1  /" 		\
#		  -e "s/\*\/[ 	]*$$//"					\
#		  -e "s/[ 	]*$$//"					\
#		$< >$@

# --- configuration ---------------------------------------------------

${srcdir}/Makefile: Makefile.in configure
	cd ${srcdir} && ./configure

# --- maintainer only -------------------------------------------------

autoconf: ${srcdir}/configure

${srcdir}/configure: configure.in $(wildcard aclocal.m4)
	cd ${srcdir} && autoconf

# ---------------------------------------------------------------------
#
# $Log$
# Revision 1.5  2003/01/13 15:42:41  cl
# - autoconf update for cross-compilation
#
# Revision 1.4  2002/08/10 18:46:57  cl
# - autoconf: install location now configurable
#
# Revision 1.3  2002/08/10 17:34:54  cl
# - update for autoconf
#
# Revision 1.2  2002/01/13 22:50:15  cl
# - update
#
# Revision 1.1  2002/01/13 21:52:16  cl
# - added a start for autoconf configuration
#
